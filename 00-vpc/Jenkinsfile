pipeline {
    agent { label 'AGENT-1' }

    environment {
        PROJECT   = 'expense'
        COMPONENT = 'backend'
        DEPLOY    = 'qa'
    }

    options {
        disableConcurrentBuilds()
        timeout(time: 10, unit: 'MINUTES')
    }

    stages {

        stage('init') {
            steps {
                script {
                    withAWS(region: 'us-east-1', credentials: 'aws-creds') {
                        sh '''
                            cd 00-vpc
                            terraform init -reconfigure
                        '''
                    }
                }
                sleep 5
            }
        }

        stage('Test') {
            when {
                environment name: 'DEPLOY', value: 'qa'
            }
            steps {
                sh '''
                    echo "Hello, this is test"
                '''
            }
        }

        stage('Deploy') {
            input {
                message "Should we continue?"
                ok "Yes we should"
            }
            steps {
                sh '''
                    echo "Hello, this is deploy"
                '''
            }
        }

        stage('Parallel Stages') {
            parallel {
                stage('STAGE-1') {
                    steps {
                        sh '''
                            echo "Hello, this is STAGE-1"
                            sleep 15
                        '''
                    }
                }
                stage('STAGE-2') {
                    steps {
                        sh '''
                            echo "Hello, this is STAGE-2"
                            sleep 15
                        '''
                    }
                }
            }
        }
    }

    post {
        always {
            echo "I will say hello again"
            deleteDir()
        }
        failure {
            echo "I will run when pipeline fails"
        }
        success {
            echo "I will run when pipeline succeeds"
        }
    }
}
